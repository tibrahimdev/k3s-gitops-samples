# Create namespace
---
apiVersion: v1
kind: Namespace
metadata:
  name: surveillance-camera-site

# Create project
---
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: {{ .Values.config.project }}
  namespace: argocd
spec:
  description: {{ .Values.config.description }}

  # Allow apps in this project to deploy to this cluster/namespace
  destinations:
    - namespace: argocd
      server: {{ .Values.config.destination.server }}
    - namespace: surveillance-camera-site
      server: {{ .Values.config.destination.server }}

  # Allow apps to source from these Git repos
  sourceRepos:
    - {{ .Values.config.source.repoURL }}

  # Optionally restrict what they can do
  clusterResourceWhitelist:
    - group: '*'
      kind: '*'

# Create root app
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: surveillance-camera-site-root-app
  namespace: argocd
spec:
  project: {{ .Values.config.project }}
  destination:
    server: {{ .Values.config.destination.server }}
    namespace: argocd
  source:
    repoURL: {{ .Values.config.source.repoURL }}
    targetRevision: {{ .Values.config.source.targetRevision }}
    path: surveillance-camera-site/bootstrap
    directory:
      recurse: true
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    # syncOptions:
    #   - ApplyOutOfSyncOnly=true
    #   - PruneLast=true
    #   - CreateNamespace=true
    #   - Validate=false

